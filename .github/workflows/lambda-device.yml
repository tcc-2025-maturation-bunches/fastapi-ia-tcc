name: Pipeline CI/CD - Lambda Device Management

on:
  push:
    branches:
      - main
    paths:
      - 'lambda-device-management/**'
      - 'shared-libs/**'
      - '.github/workflows/lambda-device.yaml'
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]
    paths:
      - 'lambda-device-management/**'
      - 'shared-libs/**'
      - '.github/workflows/lambda-device.yaml'

env:
  AWS_REGION: us-east-1
  LAMBDA_NAME: fruit-detection-device-management
  PYTHON_VERSION: '3.13'
  TAG_ENVIRONMENT: graduacao
  TAG_PROJECT: tcc
  TAG_GROUP: cicd15
  TAG_OWNER: bossini
  TAG_CREATOR: 22.01019-0

permissions:
  id-token: write
  contents: read

jobs:
  test:
    name: Testes e Verifica√ß√£o de Qualidade
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar biblioteca compartilhada
        run: |
          cd shared-libs
          pip install -e .
          cd ..

      - name: Instalar depend√™ncias da Lambda
        working-directory: lambda-device-management
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || echo "No dev requirements"

      - name: Verificar formata√ß√£o com Black e Ruff
        working-directory: lambda-device-management
        run: |
          black --check src/
          ruff check src/

      - name: Executar testes
        working-directory: lambda-device-management
        run: |
          python -m pytest tests/ -v || echo "Testes n√£o encontrados"

  build:
    name: Build e Valida√ß√£o
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && startsWith(github.head_ref, 'release/'))
    
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Criar pacote de implanta√ß√£o
        working-directory: lambda-device-management
        run: |
          mkdir -p deployment/src
          
          cp -r src/* deployment/src/
          
          pip install -r requirements.txt -t deployment/
          
          cd ../shared-libs
          pip install . -t ../lambda-device-management/deployment/
          cd ../lambda-device-management
          
          cd deployment
          zip -r ../lambda-device-management.zip .
          cd ..
          
          echo "Package size: $(du -h lambda-device-management.zip | cut -f1)"

      - name: Upload artefato
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package
          path: lambda-device-management/lambda-device-management.zip
          retention-days: 7

  deploy-hom:
    name: Implanta√ß√£o para Homologa√ß√£o
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request' && startsWith(github.head_ref, 'release/')
    environment: homologation
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Ensure AWS CLI v2
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update

      - name: Download do pacote lambda
        uses: actions/download-artifact@v4
        with:
          name: lambda-package
          path: ./

      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_KEY }}
          role-session-name: github-actions-lambda-device-hom
          aws-region: ${{ env.AWS_REGION }}

      - name: Implantar no Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_NAME }}-hom \
            --zip-file fileb://lambda-device-management.zip \
            --publish

      - name: Aplicar tags na fun√ß√£o Lambda
        run: |
          aws lambda tag-resource \
            --resource arn:aws:lambda:${{ env.AWS_REGION }}:$(aws sts get-caller-identity --query Account --output text):function:${{ env.LAMBDA_NAME }}-hom \
            --tags environment=${{ env.TAG_ENVIRONMENT }},project=${{ env.TAG_PROJECT }},group=${{ env.TAG_GROUP }},branch=${{ github.head_ref }},deployed_by=github-actions,deployment_date=$(date +%Y-%m-%d)

      - name: Aguardar atualiza√ß√£o do Lambda
        run: |
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_NAME }}-hom

      - name: Aplicar tags no CloudWatch Log Group
        run: |
          LOG_GROUP="/aws/lambda/${{ env.LAMBDA_NAME }}-hom"

          EXISTING_LOG_GROUP=$(aws logs describe-log-groups --log-group-name-prefix "$LOG_GROUP" --query 'logGroups[0].logGroupName' --output text)
          if [ -z "$EXISTING_LOG_GROUP" ] || [ "$EXISTING_LOG_GROUP" = "None" ]; then
            aws logs create-log-group --log-group-name "$LOG_GROUP"
          fi
          
          aws logs tag-log-group \
            --log-group-name "$LOG_GROUP" \
            --tags environment=${{ env.TAG_ENVIRONMENT }},project=${{ env.TAG_PROJECT }},group=${{ env.TAG_GROUP }},owner=${{ env.TAG_OWNER }},creator=${{ env.TAG_CREATOR }}

      - name: Teste de funcionamento - Health Check
        run: |
          echo "Testando endpoints de sa√∫de..."
          
          echo '{
            "version": "2.0",
            "routeKey": "GET /health",
            "rawPath": "/health",
            "rawQueryString": "",
            "headers": {
              "accept": "application/json",
              "content-length": "0",
              "host": "lambda-url.us-east-1.on.aws",
              "user-agent": "github-actions/1.0"
            },
            "requestContext": {
              "accountId": "anonymous",
              "apiId": "api-id",
              "domainName": "lambda-url.us-east-1.on.aws",
              "domainPrefix": "lambda-url",
              "http": {
                "method": "GET",
                "path": "/health",
                "protocol": "HTTP/1.1",
                "sourceIp": "127.0.0.1",
                "userAgent": "github-actions/1.0"
              },
              "requestId": "test-request-id-health",
              "routeKey": "GET /health",
              "stage": "$default",
              "time": "23/Aug/2025:18:00:00 +0000",
              "timeEpoch": 1756000800000
            },
            "isBase64Encoded": false
          }' > health_test.json
          
          aws lambda invoke \
            --function-name ${{ env.LAMBDA_NAME }}-hom \
            --payload fileb://health_test.json \
            response.json

          echo "Resposta da Lambda:"
          cat response.json

  deploy-prod:
    name: Implanta√ß√£o para Produ√ß√£o
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Ensure AWS CLI v2
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update

      - name: Download do pacote lambda
        uses: actions/download-artifact@v4
        with:
          name: lambda-package
          path: ./

      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_KEY }}
          role-session-name: github-actions-lambda-device-prod
          aws-region: ${{ env.AWS_REGION }}

      - name: Implantar no Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_NAME }}-prod \
            --zip-file fileb://lambda-device-management.zip

      - name: Aplicar tags na fun√ß√£o Lambda
        run: |
          aws lambda tag-resource \
            --resource arn:aws:lambda:${{ env.AWS_REGION }}:$(aws sts get-caller-identity --query Account --output text):function:${{ env.LAMBDA_NAME }}-prod \
            --tags environment=${{ env.TAG_ENVIRONMENT }},project=${{ env.TAG_PROJECT }},group=${{ env.TAG_GROUP }},owner=${{ env.TAG_OWNER }},creator=${{ env.TAG_CREATOR }},branch=main,deployed_by=github-actions,deployment_date=$(date +%Y-%m-%d)

      - name: Aguardar atualiza√ß√£o do Lambda
        run: |
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_NAME }}-prod

      - name: Aplicar tags no CloudWatch Log Group
        run: |
          LOG_GROUP="/aws/lambda/${{ env.LAMBDA_NAME }}-prod"

          EXISTING_LOG_GROUP=$(aws logs describe-log-groups --log-group-name-prefix "$LOG_GROUP" --query 'logGroups[0].logGroupName' --output text)
          if [ -z "$EXISTING_LOG_GROUP" ] || [ "$EXISTING_LOG_GROUP" = "None" ]; then
            aws logs create-log-group --log-group-name "$LOG_GROUP"
          fi
          
          aws logs tag-log-group \
            --log-group-name "$LOG_GROUP" \
            --tags environment=${{ env.TAG_ENVIRONMENT }},project=${{ env.TAG_PROJECT }},group=${{ env.TAG_GROUP }},owner=${{ env.TAG_OWNER }},creator=${{ env.TAG_CREATOR }}

      - name: Teste de funcionamento - Health Check
        run: |
          echo '{
            "version": "2.0",
            "routeKey": "GET /health",
            "rawPath": "/health",
            "rawQueryString": "",
            "headers": {
              "accept": "application/json",
              "content-length": "0",
              "host": "lambda-url.us-east-1.on.aws",
              "user-agent": "github-actions/1.0"
            },
            "requestContext": {
              "accountId": "anonymous",
              "apiId": "api-id",
              "domainName": "lambda-url.us-east-1.on.aws",
              "domainPrefix": "lambda-url",
              "http": {
                "method": "GET",
                "path": "/health",
                "protocol": "HTTP/1.1",
                "sourceIp": "127.0.0.1",
                "userAgent": "github-actions/1.0"
              },
              "requestId": "test-request-id-health",
              "routeKey": "GET /health",
              "stage": "$default",
              "time": "23/Aug/2025:18:00:00 +0000",
              "timeEpoch": 1756000800000
            },
            "isBase64Encoded": false
          }' > health_payload.json
          
          aws lambda invoke \
            --function-name ${{ env.LAMBDA_NAME }}-prod \
            --payload fileb://health_payload.json \
            response.json
          
          echo "Resposta da Lambda:"
          cat response.json

      - name: Notificar equipe sobre implanta√ß√£o no Discord
        if: always()
        run: |
          STATUS="${{ job.status == 'success' && '‚úÖ Sucesso' || '‚ùå Falhou' }}"
          COLOR="${{ job.status == 'success' && '3066993' || '15158332' }}"
          TITLE="Lambda Device Management - $STATUS"
          
          DESCRIPTION="Deploy da Lambda Device Management em produ√ß√£o"
          if [ "${{ job.status }}" == "success" ]; then
            DESCRIPTION="$DESCRIPTION conclu√≠do com sucesso! üéâ\n\n**Funcionalidades:**\n‚Ä¢ Gerenciamento de dispositivos Raspberry Pi\n‚Ä¢ Monitoramento de heartbeat\n‚Ä¢ Estat√≠sticas de captura\n‚Ä¢ Detec√ß√£o autom√°tica de dispositivos offline"
          else
            DESCRIPTION="$DESCRIPTION falhou! ‚ùå\n\nVerifique os logs do GitHub Actions para detalhes."
          fi
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"description\": \"$DESCRIPTION\",
                \"color\": $COLOR,
                \"fields\": [
                  {
                    \"name\": \"Ambiente\",
                    \"value\": \"Produ√ß√£o\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Commit\",
                    \"value\": \"${{ github.sha }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Tags\",
                    \"value\": \"environment=${{ env.TAG_ENVIRONMENT }}, project=${{ env.TAG_PROJECT }}, group=${{ env.TAG_GROUP }}, owner=${{ env.TAG_OWNER }}, creator=${{ env.TAG_CREATOR }}\",
                    \"inline\": false
                  }
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }" \
            ${{ secrets.DISCORD_WEBHOOK }}