name: Pipeline CI/CD - Lambda Request Handler (Test OIDC)

on:
  push:
    branches:
      - oidc-aws-ci
    paths:
      - 'lambda-request-handler/**'
      - 'shared-libs/**'
      - '.github/workflows/test.yaml'

env:
  AWS_REGION: us-east-1
  LAMBDA_NAME: fruit-detection-request-handler
  PYTHON_VERSION: '3.13'
  TAG_ENVIRONMENT: graduacao
  TAG_PROJECT: TCC
  TAG_GROUP: CICD15

permissions:
  id-token: write
  contents: read

jobs:
  test:
    name: Testes e Verificação de Qualidade (OIDC Branch)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar biblioteca compartilhada
        run: |
          cd shared-libs
          pip install -e .
          cd ..

      - name: Instalar dependências da Lambda
        working-directory: lambdas/request-handler
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || echo "No dev requirements"

      - name: Verificar formatação com Black e Ruff
        working-directory: lambdas/request-handler
        run: |
          black --check src/
          ruff check src/

      - name: Executar testes
        working-directory: lambdas/request-handler
        run: |
          python -m pytest tests/ -v || echo "Testes não encontrados"

  build:
    name: Build e Validação (OIDC Test)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Criar pacote de implantação
        working-directory: lambdas/request-handler
        run: |
          mkdir -p deployment/src
          
          # Copiar código fonte
          cp -r src/* deployment/src/
          
          # Instalar dependências no diretório de deployment
          pip install -r requirements.txt -t deployment/
          
          # Instalar shared-libs no diretório de deployment
          cd ../../shared-libs
          pip install . -t ../lambdas/request-handler/deployment/
          cd ../lambdas/request-handler
          
          # Criar arquivo zip
          cd deployment
          zip -r ../lambda-request-handler.zip .
          cd ..
          
          echo "Package size: $(du -h lambda-request-handler.zip | cut -f1)"

      - name: Upload artefato
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package-test
          path: lambdas/request-handler/lambda-request-handler.zip
          retention-days: 1

  deploy-test:
    name: Teste de Implantação AWS (OIDC)
    runs-on: ubuntu-latest
    needs: build
    environment: test

    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Download do pacote lambda
        uses: actions/download-artifact@v4
        with:
          name: lambda-package-test
          path: ./

      - name: Configurar credenciais AWS via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_KEY }}
          role-session-name: github-actions-lambda-request-test
          aws-region: ${{ env.AWS_REGION }}

      - name: Verificar conectividade AWS
        run: |
          aws sts get-caller-identity
          aws lambda list-functions --query 'Functions[?FunctionName==`${{ env.LAMBDA_NAME }}-test`]'

      - name: Criar função Lambda de teste se não existir
        run: |
          set -e
          FUNCTION_NAME="${{ env.LAMBDA_NAME }}-test"
          EXISTS=$(aws lambda list-functions --query "Functions[?FunctionName=='$FUNCTION_NAME'] | length(@)")
          if [ "$EXISTS" -eq "0" ]; then
            aws lambda create-function \
              --function-name "$FUNCTION_NAME" \
              --runtime python3.13 \
              --role ${{ secrets.AWS_OIDC_KEY }} \
              --handler src.app.lambda_handler.lambda_handler \
              --zip-file fileb://lambda-request-handler.zip \
              --timeout 30 \
              --memory-size 1024
            echo "Função Lambda criada: $FUNCTION_NAME"
          else
            echo "Função Lambda já existe: $FUNCTION_NAME"
          fi

      - name: Implantar no Lambda de teste
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_NAME }}-test \
            --zip-file fileb://lambda-request-handler.zip \
            --publish
            
      - name: Aguardar atualização do Lambda
        run: |
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_NAME }}-test

      - name: Teste de funcionamento - Health Check
        run: |
          echo '{
            "version": "2.0",
            "routeKey": "GET /health",
            "rawPath": "/health",
            "rawQueryString": "",
            "headers": {
              "accept": "application/json",
              "content-length": "0",
              "host": "lambda-url.us-east-1.on.aws",
              "user-agent": "curl/8.0.0",
              "x-amzn-trace-id": "Root=1-abcdef-0123456789"
            },
            "requestContext": {
              "accountId": "anonymous",
              "apiId": "api-id",
              "domainName": "lambda-url.us-east-1.on.aws",
              "domainPrefix": "lambda-url",
              "http": {
                "method": "GET",
                "path": "/health",
                "protocol": "HTTP/1.1",
                "sourceIp": "127.0.0.1",
                "userAgent": "curl/8.0.0"
              },
              "requestId": "test-request-id-health",
              "routeKey": "GET /health",
              "stage": "$default",
              "time": "23/Aug/2025:18:00:00 +0000",
              "timeEpoch": 1756000800000
            },
            "isBase64Encoded": false
          }' > test_payload.json
          
          aws lambda invoke \
            --function-name ${{ env.LAMBDA_NAME }}-test \
            --payload fileb://test_payload.json \
            response.json
          
          echo "Resposta da Lambda:"
          cat response.json

      - name: Verificar logs da Lambda
        if: always()
        run: |
          echo "=== Últimos logs da Lambda ==="
          aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/${{ env.LAMBDA_NAME }}-test" --query 'logGroups[0].logGroupName' --output text | xargs -I {} aws logs describe-log-streams --log-group-name {} --order-by LastEventTime --descending --max-items 1 --query 'logStreams[0].logStreamName' --output text | xargs -I {} aws logs get-log-events --log-group-name "/aws/lambda/${{ env.LAMBDA_NAME }}-test" --log-stream-name {} --query 'events[*].message' --output text || echo "Não foi possível obter logs"

      - name: Notificar sucesso do teste OIDC
        if: success()
        run: |
          echo "✅ Teste de implantação OIDC executado com sucesso!"
          echo "Function: ${{ env.LAMBDA_NAME }}-test"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Branch: oidc-aws-ci"